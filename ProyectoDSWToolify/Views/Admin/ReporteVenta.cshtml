@using ProyectoDSWToolify.Models.ViewModels.AdminVM
@model IEnumerable<ListadoVentaFechaAndTipoVentaDTO>

@{
	ViewData["Title"] = "Reporte de Ventas";
	Layout = "~/Views/Shared/_LayoutAdmin.cshtml";

	string fechaInicio = Context.Request.Query["fechaInicio"];
	string fechaFin = Context.Request.Query["fechaFin"];
	string tipoSeleccionado = Context.Request.Query["tipo"];
	bool esPresencial = tipoSeleccionado == "P";
	bool esRemota = tipoSeleccionado == "R";

	int paginaActual = ViewBag.pagActual ?? 1;
	int totalPaginas = ViewBag.numeroPag ?? 1;
}

<div class="container-fluid px-4">
	<h1 class="mt-4 mb-4 fw-bold">Reporte de Ventas</h1>

	<div class="card mb-4 shadow-sm">
		<div class="card-body">
			<form asp-action="ReporteVenta" method="get" class="row g-3 align-items-end">
				<div class="col-md-3">
					<label for="fechaInicio" class="form-label fw-semibold">Fecha Inicio</label>
					<input type="date" id="fechaInicio" name="fechaInicio" class="form-control" value="@fechaInicio" />
				</div>
				<div class="col-md-3">
					<label for="fechaFin" class="form-label fw-semibold">Fecha Fin</label>
					<input type="date" id="fechaFin" name="fechaFin" class="form-control" value="@fechaFin" />
				</div>
				<div class="col-md-3">
					<label for="tipo" class="form-label fw-semibold">Tipo de Venta</label>
					<select id="tipo" name="tipo" class="form-select">
						<option value="" selected="@(string.IsNullOrEmpty(tipoSeleccionado))">-- Seleccione --</option>
						<option value="P" selected="@(esPresencial)">Presencial</option>
						<option value="R" selected="@(esRemota)">Remota</option>
					</select>
				</div>
				<div class="col-md-3 d-flex flex-column flex-md-row gap-2">
					<button type="submit" class="btn btn-primary w-100 w-md-auto">
						<i class="bi bi-search me-1"></i> Buscar
					</button>
					<a asp-action="ReporteVenta"
					   asp-route-fechaInicio="@fechaInicio"
					   asp-route-fechaFin="@fechaFin"
					   asp-route-tipo="@tipoSeleccionado"
					   asp-route-export="excel"
					   class="btn btn-success w-100 w-md-auto">
						<i class="bi bi-file-earmark-excel me-1"></i> Descargar Excel
					</a>
					<a asp-action="ReporteVenta"
					   asp-route-fechaInicio="@fechaInicio"
					   asp-route-fechaFin="@fechaFin"
					   asp-route-tipo="@tipoSeleccionado"
					   asp-route-export="pdf"
					   class="btn btn-danger w-100 w-md-auto">
						<i class="bi bi-file-earmark-pdf me-1"></i> Descargar PDF
					</a>
				</div>
			</form>
		</div>
	</div>

	<div class="table-responsive shadow-sm rounded">
		<table class="table table-striped table-bordered table-hover align-middle text-center mb-0">
			<thead class="table-dark">
				<tr>
					<th>Id Venta</th>
					<th>Nombre</th>
					<th>Direccion</th>
					<th>Fecha Compra</th>
					<th>Total</th>
					<th>Estado</th>
					<th>Tipo Venta</th>
				</tr>
			</thead>
			<tbody>
				@if (!Model.Any())
				{
					<tr>
						<td colspan="7" class="text-center fst-italic text-muted">No se encontraron resultados.</td>
					</tr>
				}
				else
				{
					foreach (var item in Model)
					{
						<tr>
							<td>@item.idVenta</td>
							<td class="text-start">@item.nombresCompletos</td>
							<td class="text-start">@item.direccion</td>
							<td>@item.fechaGenerada.ToString("dd/MM/yyyy")</td>
							<td class="fw-semibold text-success">S/. @item.total.ToString("F2")</td>
							<td>
								@{
									var estado = item.estado.ToUpper();
								}
								@if (estado == "C")
								{
									<span>
										<i class="fa-solid fa-xmark text-danger" title="Cancelado"></i>
										Cancelado
									</span>
								}
								else if (estado == "E")
								{
									<span>
										<i class="fa-solid fa-check text-success" title="Entregado"></i>
										Entregado
									</span>
								}
								else if (estado == "P")
								{
									<span>
										<i class="fa-solid fa-hourglass-half text-warning" title="Pendiente"></i>
										Pendiente
									</span>
								}
								else if (estado == "G")
								{
									<span>
										<i class="fa-solid fa-file-alt text-info" title="Generado"></i>
										Generado
									</span>
								}
								else if (estado == "T")
								{
									<span>
										<i class="fa-solid fa-truck text-primary" title="Transportado"></i>
										Transportado
									</span>
								}
								else
								{
									<i class="fa-solid fa-question text-muted" title="@item.estado"></i> @item.estado
								}
							</td>

							<td>
								@if (item.tipoVenta == "P")
								{
									<span>
										<i class="fa-solid fa-person text-primary" title="Presencial"></i>
										Presencial
									</span>
								}
								else if (item.tipoVenta == "R")
								{
									<span>
										<i class="fa-solid fa-laptop text-info" title="Remota"></i>
										Remota
									</span>
								}
								else
								{
									<span>
										<i class="fa-solid fa-question text-muted" title="Desconocido"></i>
										Desconocido
									</span>
								}
							</td>

						</tr>
					}
				}
			</tbody>
		</table>
	</div>

	@if (totalPaginas > 1)
	{
		<nav aria-label="Page navigation example" class="mt-4 d-flex justify-content-center">
			<ul class="pagination pagination-sm mb-0">
				@for (int i = 1; i <= totalPaginas; i++)
				{
					<li class="page-item @(i == paginaActual ? "active" : "")" aria-current="page">
						<a class="page-link"
						   asp-action="ReporteVenta"
						   asp-route-pag="@i"
						   asp-route-fechaInicio="@fechaInicio"
						   asp-route-fechaFin="@fechaFin"
						   asp-route-tipo="@tipoSeleccionado">
							@i
						</a>
					</li>
				}
			</ul>
		</nav>
	}
</div>

@using ProyectoDSWToolify.Models.ViewModels.VendedorVM
@model ListadoHistorialViewModel

@{
	ViewData["Title"] = "Historial";
	Layout = "~/Views/Shared/_LayoutVendedor.cshtml";
}

<div class="container-xl py-4">
	<header class="mb-4">
		<h1 class="fs-2 fw-bold text-dark d-flex align-items-center gap-2">
			<i class="fas fa-clock text-primary-custom"></i> Historial de Ventas
		</h1>
		<p class="text-secondary fs-5">Consulta y gestiona el historial de todas tus ventas registradas.</p>
	</header>

	<!-- Tarjetas resumen -->
	<section class="row g-4 mb-5">
		<div class="col-md-4">
			<div class="card shadow-sm border-primary rounded-4">
				<div class="card-body d-flex justify-content-between align-items-center p-4">
					<div>
						<p class="text-muted small mb-1">Total de Ventas</p>
						<p id="totalVentas" class="fs-2 fw-bold text-dark mb-1">0</p>
						<small class="text-muted">Transacciones registradas</small>
					</div>
					<i class="fas fa-shopping-cart fs-2 text-primary-custom"></i>
				</div>
			</div>
		</div>
		<div class="col-md-4">
			<div class="card shadow-sm border-success rounded-4">
				<div class="card-body d-flex justify-content-between align-items-center p-4">
					<div>
						<p class="text-muted small mb-1">Productos Vendidos</p>
						<p id="totalProductos" class="fs-2 fw-bold text-dark mb-1">0</p>
						<small class="text-muted">Unidades totales</small>
					</div>
					<i class="fas fa-box fs-2 text-success"></i>
				</div>
			</div>
		</div>
		<div class="col-md-4">
			<div class="card shadow-sm border-warning rounded-4">
				<div class="card-body d-flex justify-content-between align-items-center p-4">
					<div>
						<p class="text-muted small mb-1">Ingresos Totales</p>
						<p id="ingresosTotales" class="fs-2 fw-bold text-dark mb-1">S/ 0.00</p>
						<small class="text-muted">Monto acumulado</small>
					</div>
					<i class="fas fa-money-bill-wave fs-2 text-warning"></i>
				</div>
			</div>
		</div>
	</section>

	<!-- Tabla de ventas -->
	<section>
		<div class="card shadow rounded-4 border-0">
			<div class="d-flex justify-content-between align-items-center px-4 py-3">
				<h4 class="mb-0 fw-bold text-dark">
					<i class="fas fa-list me-2 text-primary-custom"></i> Listado de Ventas
				</h4>
				<span class="badge bg-color-primary">@Model.HistorialVentas.Count() resultados</span>
			</div>
			<div class="card-body p-0">
				<div class="table-responsive">
					<table class="table table-hover align-middle text-center mb-0">
						<thead class="table-light">
							<tr>
								<th>ID Venta</th>
								<th>Fecha</th>
								<th>Productos</th>
								<th>Total</th>
								<th>Estado</th>
								<th>Acciones</th>
							</tr>
						</thead>
						<tbody>
							@if (Model.HistorialVentas.Any())
							{
								foreach (var venta in Model.HistorialVentas)
								{
									var estadoTexto = venta.estado switch
									{
										"G" => "Generado",
										"T" => "Transportado",
										"E" => "Entregado",
										"P" => "Pendiente",
										"C" => "Cancelado",
										_ => "Desconocido"
									};
									<tr>
										<td class="font-monospace">#@venta.idVenta</td>
										<td>@venta.fecha.ToString("dd/MM/yyyy")</td>
										<td>
											@venta.Detalles.Count() productos
										</td>
										<td class="fw-bold">S/. @venta.total.ToString("N2")</td>
										<td>
											<span class="bg-warning badge text-white">
												@estadoTexto
											</span>
										</td>
										<td>
											<button class="btn btn-sm btn-outline-secondary me-1 btn-detalle-venta"
													data-bs-toggle="modal"
													data-bs-target="#detalleVentaModal"
													data-idventa="@venta.idVenta">
												<i class="bi bi-eye"></i>
											</button>
											<a asp-action="DescargarVentaPdf"
											   asp-controller="Vendedor"
											   asp-route-idVenta="@venta.idVenta"
											   asp-route-idUsuario="@Model.idVendedor"
											   target="_blank"
											   class="btn btn-sm btn-outline-secondary">
												<i class="bi bi-download"></i>
											</a>
										</td>
									</tr>
								}
							}
							else
							{
								<tr>
									<td colspan="7" class="text-muted text-center py-4">
										<i class="fas fa-box-open fa-2x mb-2 text-secondary"></i><br />
										No hay ventas registradas.
									</td>
								</tr>
							}
						</tbody>
					</table>
				</div>
			</div>
		</div>
	</section>

	<!-- Modal Detalle de Venta -->
	<div class="modal fade" id="detalleVentaModal" tabindex="-1" aria-labelledby="detalleVentaLabel" aria-hidden="true">
		<div class="modal-dialog modal-lg modal-dialog-scrollable">
			<div class="modal-content rounded-4 shadow border-0">
				<div class="modal-header bg-color-primary text-white rounded-top-4">
					<h5 class="modal-title fw-semibold" id="detalleVentaLabel">
						<i class="fas fa-receipt me-2"></i> Detalle de Venta
					</h5>
					<button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Cerrar"></button>
				</div>
				<div class="modal-body p-4">
					<!-- Aquí se insertan los detalles dinámicamente -->
					<div class="text-center text-muted">Cargando detalles...</div>
				</div>
				<div class="modal-footer bg-light rounded-bottom-4">
					<button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
						<i class="fas fa-times me-1"></i> Cerrar
					</button>
				</div>
			</div>
		</div>
	</div>

</div>

@section Scripts {
	<script src="~/js/HistorialVendedor.js"></script>
}
